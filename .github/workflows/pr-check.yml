name: PR Compliance Check

on:
  pull_request_target:
    types: [opened, edited, synchronize, reopened]

jobs:
  check-compliance:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read

    steps:
      - name: Check PR Template Compliance
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const author = context.payload.pull_request.user.login;
            
            // Check if required sections are filled
            const hasDescription = body.includes('## Description') && 
                                   body.split('## Description')[1]?.split('##')[0]?.trim().length > 10;
            const hasRelatedIssue = /Resolves #\d+|Fixes #\d+|Closes #\d+/.test(body);
            const hasTypeChecked = /- \[x\].*Bug fix|New feature|Breaking change|Documentation|UI\/UX|Performance|refactoring|Test/.test(body);
            const hasGuidelinesChecked = /- \[x\].*read the.*CONTRIBUTING/i.test(body);
            const hasCodeReviewed = /- \[x\].*performed a self-review/i.test(body);
            const hasAiDisclosure = /- \[x\].*Did you use AI tools/i.test(body) || /- \[ \].*Did you use AI tools/i.test(body);
            
            let issues = [];
            let warnings = [];
            
            if (!hasDescription) {
              issues.push('‚ùå **Missing Description**: Please provide a clear description of your changes');
            }
            
            if (!hasRelatedIssue) {
              warnings.push('‚ö†Ô∏è **Related Issue**: Consider linking an issue (e.g., "Resolves #123")');
            }
            
            if (!hasTypeChecked) {
              issues.push('‚ùå **Type of Change**: Please check at least one type of change');
            }
            
            if (!hasGuidelinesChecked) {
              issues.push('‚ùå **Contributing Guidelines**: Please confirm you have read CONTRIBUTING.md');
            }
            
            if (!hasCodeReviewed) {
              issues.push('‚ùå **Self Review**: Please perform a self-review of your code');
            }
            
            if (!hasAiDisclosure) {
              issues.push('‚ùå **AI Disclosure**: Please indicate whether you used AI tools (Yes/No checkbox)');
            }
            
            // Check if this is a first-time contributor
            const { data: authorPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: author,
              per_page: 2
            });
            
            const isFirstPR = authorPRs.length === 1; // Only this PR exists
            
            // Build comment message
            let comment = '';
            
            if (isFirstPR) {
              comment += `## üéâ Welcome to GenForm!\n\n`;
              comment += `Hi @${author}! üëã Thank you for opening your first pull request! We're excited to have you contribute to GenForm. `;
              comment += `A maintainer will review your PR soon.\n\n`;
              comment += `While you wait, please make sure your PR follows our guidelines below. üöÄ\n\n`;
              comment += `---\n\n`;
            }
            
            // Check for existing bot comments
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              (comment.body.includes('PR Checklist Review') || 
               comment.body.includes('PR Checklist Complete') ||
               comment.body.includes('Welcome to GenForm'))
            );
            
            if (issues.length > 0 || warnings.length > 0) {
              comment += `## üìã PR Checklist Review\n\n`;
              comment += `Thank you for your contribution! Please address the following items:\n\n`;
              
              if (issues.length > 0) {
                comment += `### Required Actions\n\n`;
                issues.forEach(issue => {
                  comment += `${issue}\n`;
                });
                comment += `\n`;
              }
              
              if (warnings.length > 0) {
                comment += `### Suggestions\n\n`;
                warnings.forEach(warning => {
                  comment += `${warning}\n`;
                });
                comment += `\n`;
              }
              
              comment += `---\n\n`;
              comment += `Please edit your PR description to complete all required items. `;
              comment += `Once done, this check will automatically pass! ‚úÖ\n\n`;
              comment += `Need help? Check out our [Contributing Guidelines](../CONTRIBUTING.md) or ask in the comments!`;
              
              // Update existing comment or create new one
              if (botComment) {
                await github.rest.issues.updateComment({
                  comment_id: botComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              } else {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
              
              // Set status check
              if (issues.length > 0) {
                core.setFailed('PR template compliance check failed. Please complete all required items.');
              }
            } else {
              // Everything is good!
              let successComment = '';
              
              if (isFirstPR) {
                successComment += `## üéâ Welcome to GenForm!\n\n`;
                successComment += `Hi @${author}! üëã Thank you for opening your first pull request! `;
                successComment += `Your PR looks great and follows all our guidelines. `;
                successComment += `A maintainer will review it soon. Welcome to the community! üöÄ\n`;
              } else {
                successComment += `## ‚úÖ PR Checklist Complete\n\n`;
                successComment += `Great job @${author}! Your PR follows all the guidelines. `;
                successComment += `A maintainer will review it soon. Thank you for your contribution! üôè\n`;
              }
              
              // Update existing comment or create new one
              if (botComment) {
                await github.rest.issues.updateComment({
                  comment_id: botComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: successComment
                });
              } else {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: successComment
                });
              }
            }

      - name: Label first-time contributors
        if: github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.pull_request.user.login;
            
            const { data: prList } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: author,
              per_page: 100
            });
            
            if (prList.length === 1) {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['first-time-contributor']
              });
            }
